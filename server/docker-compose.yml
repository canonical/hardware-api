version: "3.8"
services:
  hwapi-dev:
    build:
      context: .
      dockerfile: Dockerfile
    command: ./scripts/dev-docker-entrypoint.sh
    working_dir: /home/app
    volumes:
      - .:/home/app
      - ./data:/home/app/data
    ports:
      - "8080:8080"
    environment:
      - DB_URL=sqlite:////home/app/data/hwapi-dev.db
      - C3_URL=http://172.17.0.1:8001
      - INTERNAL_HOSTS=*

  hwapi-test:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      bash -c '
        black --check hwapi/ scripts/ tests/ &&
        ruff check hwapi/ scripts/ tests/ --no-cache &&
        mypy hwapi/ scripts/ tests/ &&
        pytest tests/ -vv'
    working_dir: /home/app
    tmpfs:
      - /home/app/data
    ports:
      - "8080:8080"
    environment:
      - TEST_DB_URL=sqlite:////home/app/data/test-hwapi.db

  hwapi:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /home/app
    volumes:
      - ./data:/home/app/data
    ports:
      - "8080:8080"
    environment:
      - DB_URL=sqlite:////home/app/data/hwapi.db
      - C3_URL=https://certification.canonical.com

version: "3.8"
services:
  hwapi-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DATA_LOADING_SCRIPT_FILE: ${DATA_LOADING_SCRIPT_FILE:-import_from_c3.py}
        DB_URL: sqlite:////home/app/hwapi.db
        C3_URL: ${C3_URL:-https://certification.staging.canonical.com}
    command: uvicorn hwapi.main:app --host 0.0.0.0 --port 8080 --reload
    working_dir: /home/app
    volumes:
      - ./hwapi:/home/app/hwapi
    ports:
      - "8080:8080"

  hwapi-test:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DATA_LOADING_SCRIPT_FILE:
        C3_URL: https://c3_url
        DB_URL: sqlite:////home/app/test.db
    command: >
      bash -c '
        black --check hwapi/ scripts/ tests/ &&
        ruff check hwapi/ scripts/ tests/ --no-cache &&
        mypy hwapi/ scripts/ tests/ &&
        pytest tests/ -vv'
    working_dir: /home/app
    ports:
      - "8080:8080"

  hwapi:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DB_URL: sqlite:////home/app/hwapi.db
        C3_URL: https://certification.canonical.com
    working_dir: /home/app
    ports:
      - "8080:8080"
